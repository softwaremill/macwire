import akka.actor.{Actor, ActorRef, ActorSystem, IndirectActorProducer, Props}
import com.softwaremill.macwire.akkasupport._

/**
  * In this example I am constructing actor within actor.
  * SomeActor is created by system but Subordinates are created as children of SomeActor.
  *
  */

trait A
class B
trait C

class Subordinate(a: A)(b: B, c: C) extends Actor {
  override def receive: Receive = {
    case m => //println(m)
  }
}

class SubordinateFactory(a: A)(b: B) extends IndirectActorProducer {
  override def produce(): Actor = new Subordinate(a)(b, new C{})
  override def actorClass: Class[_ <: Actor] = classOf[SomeActor]
}

class SomeActor(a: A) extends Actor {

  val b = new B {}
  lazy val c: C = throw new UnsupportedOperationException()

  val subordinates: Seq[ActorRef] = (0 to 2).map { i =>
    //subordinate depends on A and B which are in scope
    val props: Props = wirePropsWith[SubordinateFactory]
    context.actorOf(props, s"sub$i")
  }

  override def receive: Receive = {
    case m => subordinates.foreach(_ ! m)
  }
}

val a = new A {}

val system = ActorSystem("wirePropsWithProducer-10-makeActorInActor")
AfterAllTerminate(system)

val someActor = wireActor[SomeActor]("someActor")

someActor ! "Hey someActor"
